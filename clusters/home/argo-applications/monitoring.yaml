apiVersion: v1
kind: Namespace
metadata:
  name: monitoring

---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: grafana
  namespace: argocd
spec:
  project: default
  source:
    chart: grafana
    repoURL: https://grafana.github.io/helm-charts
    targetRevision: 9.3.4
    helm:
      releaseName: grafana
      values: |
        assertNoLeakedSecrets: false
        grafana.ini:
          analytics:
            reporting_enabled: false
            check_for_plugin_updates: true
          auth:
            disable_login: true
            disable_login_form: true
            disable_signout_menu: true
          auth.anonymous:
            enabled: true
            org_name: Main Org.
            org_role: Admin
          auth.basic:
            enabled: false
          server:
            domain: grafana.ig.ingtra.net
            root_url: "%(protocol)s://%(domain)s"
          database:
            type: postgres
            host: postgresql.vd.ingtra.net:5432
            name: grafana
            user: system
            password: systemsecret
  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring

---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: tempo
  namespace: argocd
spec:
  project: default
  source:
    chart: tempo
    repoURL: https://grafana.github.io/helm-charts
    targetRevision: 1.23.3
    helm:
      releaseName: tempo
      values: |
        replicas: 1
        tempo:
          reportingEnabled: false
          ingester:
            max_block_duration: 5m
            flush_all_on_shutdown: true
          metricsGenerator:
            enabled: true
          storage:
            trace:
              backend: s3
              s3:
                bucket: tempo
                prefix: trace/
                endpoint: s3.ingtra.net
                access_key: system
                secret_key: systemsecret
  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
---
apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  name: alloy
  namespace: argocd
spec:
  project: default
  source:
    chart: alloy
    repoURL: https://grafana.github.io/helm-charts
    targetRevision: 1.2.1
    helm:
      releaseName: alloy
      values: |
        alloy:
          clustering:
            enabled: true
          configMap:
            content: |
              logging {
                level  = "debug"
                format = "json"
              }
              otelcol.receiver.otlp "default" {
                http {
                  endpoint = "0.0.0.0:4318"
                }
                output {
                  metrics = [otelcol.processor.batch.default.input]
                  logs    = [otelcol.processor.batch.default.input]
                  traces  = [otelcol.processor.batch.default.input]
                }
              }
              otelcol.processor.batch "default" {
                output {
                  metrics = [otelcol.exporter.otlphttp.victoriametrics.input]
                  logs = [otelcol.exporter.otlphttp.victorialogs.input]
                  traces = [
                    otelcol.exporter.otlp.signoz.input,
                    otelcol.exporter.otlp.tempo.input,
                  ]
                }
              }
              otelcol.exporter.otlp "tempo" {
                client {
                  endpoint = "tempo.monitoring.svc:4317"
                  tls {
                      insecure             = true
                      insecure_skip_verify = true
                  }
                }
              }
              otelcol.exporter.otlp "signoz" {
                client {
                  endpoint = "signoz.vd.ingtra.net:4317"
                  tls {
                      insecure             = true
                      insecure_skip_verify = true
                  }
                }
              }
              otelcol.exporter.otlphttp "victoriametrics" {
                client {
                  endpoint = "http://monitoring.vd.ingtra.net:8428/opentelemetry"
                }
              }
              otelcol.exporter.otlphttp "victorialogs" {
                client {
                  endpoint = "http://monitoring.vd.ingtra.net:9428/insert/opentelemetry"
                }
              }
          extraPorts:
            - name: "otel-http"
              port: 4318
              targetPort: 4318
  destination:
    server: https://kubernetes.default.svc
    namespace: monitoring
